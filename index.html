<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYD Singapore Loan Calculator with Closing Costs - Motor-East</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding: 12px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        .header {
            text-align: center;
            color: white;
            padding: 10px 15px 5px 15px;
            position: relative;
        }

        .brand-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .brand-logo h1 {
            font-size: 2em;
            font-weight: 700;
            letter-spacing: 6px;
            color: #ffffff;
            text-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
        }

        .brand-logo .separator {
            height: 35px;
            width: 2px;
            background: linear-gradient(to bottom, transparent, #00bcd4, transparent);
        }

        .brand-logo .motoreast {
            font-size: 1.4em;
            color: #00bcd4;
            font-weight: 600;
            letter-spacing: 1.5px;
        }

        .validity-notice {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .validity-notice strong {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8em;
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .validity-notice span {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75em;
        }

        .calculator-wrapper {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 188, 212, 0.1);
        }

        .card h2 {
            color: #1a1a2e;
            margin-bottom: 15px;
            font-size: 1.5em;
            padding-bottom: 10px;
            border-bottom: 2px solid;
            border-image: linear-gradient(to right, #00bcd4, #0097a7) 1;
        }

        .form-group {
            margin-bottom: 14px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9em;
        }

        .info-icon, .warning-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
            cursor: help;
            position: relative;
        }

        .info-icon {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
        }

        .warning-icon {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 188, 212, 0.3);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -7px;
            border-width: 7px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #00bcd4;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 4px;
            background: linear-gradient(to right, #e0e0e0 0%, #e0e0e0 100%);
            outline: none;
            -webkit-appearance: none;
            margin: 8px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 188, 212, 0.4);
            transition: all 0.3s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(0, 188, 212, 0.6);
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .slider-value {
            font-weight: 700;
            color: #00bcd4;
            font-size: 1.05em;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #00bcd4;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.1);
        }

        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .input-with-prefix {
            position: relative;
        }

        .input-prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #00bcd4;
            font-weight: 700;
            font-size: 1.05em;
        }

        input.with-prefix {
            padding-left: 32px;
        }

        .down-payment-info {
            font-size: 0.82em;
            color: #0097a7;
            margin-top: 6px;
            font-weight: 500;
            padding: 6px;
            background: rgba(0, 188, 212, 0.1);
            border-radius: 4px;
            border-left: 2px solid #00bcd4;
        }

        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 188, 212, 0.5);
            background: linear-gradient(135deg, #0097a7 0%, #00838f 100%);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .result-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 15px;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(0, 188, 212, 0.3);
        }

        .result-box h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #00bcd4;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .monthly-payment-big {
            font-size: 2.8em;
            font-weight: 800;
            margin: 10px 0;
            color: #ffffff;
            text-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
            letter-spacing: -0.5px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .result-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(0, 188, 212, 0.2);
        }

        .result-label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 6px;
            color: #00bcd4;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 0.8em;
        }

        .result-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #ffffff;
        }

        .breakdown-section {
            margin-top: 15px;
        }

        .breakdown-section h3 {
            color: #1a1a2e;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
        }

        .breakdown-table tr {
            border-bottom: 1px solid #e0e0e0;
        }

        .breakdown-table td {
            padding: 10px 8px;
            font-size: 0.9em;
        }

        .breakdown-table td:first-child {
            color: #2c3e50;
            font-weight: 500;
        }

        .breakdown-table td:last-child {
            text-align: right;
            font-weight: 700;
            color: #1a1a2e;
            font-size: 0.95em;
        }

        .green-text {
            color: #27ae60 !important;
        }

        .orange-text {
            color: #f39c12 !important;
        }

        .highlight-row {
            background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%);
            font-weight: 700;
        }

        .highlight-row td {
            padding: 12px 8px;
            color: #16a085 !important;
            font-size: 1em;
        }

        /* Closing Costs Styling */
        .closing-costs-card {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 2px solid #00bcd4;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .closing-costs-header {
            padding: 20px 25px;
            cursor: pointer;
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: all 0.3s ease;
        }

        .closing-costs-header:hover {
            background: linear-gradient(135deg, #0097a7 0%, #00838f 100%);
        }

        .closing-costs-header h2 {
            color: white;
            margin: 0;
            font-size: 1.5em;
            padding: 0;
            border: none;
        }

        .toggle-icon {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 9px solid #ffffff;
            margin-left: 10px;
            transition: transform 0.3s ease;
            vertical-align: middle;
        }

        .closing-costs-card.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .closing-costs-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            padding: 0 25px;
        }

        .closing-costs-card.expanded .closing-costs-content {
            max-height: 2000px;
            padding: 25px;
        }

        .closing-costs-card.show {
            display: block;
        }

        .closing-costs-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .main-costs-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .cost-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .cost-item-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .cost-item-value {
            font-size: 1.8em;
            font-weight: 800;
            color: #1a1a2e;
        }

        .cost-item.highlight {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            border: 2px solid #00838f;
        }

        .cost-item.highlight .cost-item-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .cost-item.highlight .cost-item-value {
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .cost-item.subtle {
            background: transparent;
            border: 1px dashed #dee2e6;
            padding: 10px 15px;
        }

        .cost-item.subtle .cost-item-label {
            font-size: 0.75em;
            color: #adb5bd;
        }

        .cost-item.subtle .cost-item-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #6c757d;
        }

        .insurance-slider-inline {
            margin-top: 12px;
        }

        .insurance-slider-inline input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 4px;
            background: linear-gradient(to right, #e0e0e0 0%, #e0e0e0 100%);
            outline: none;
            -webkit-appearance: none;
        }

        .insurance-slider-inline input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .insurance-slider-inline input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .insurance-selector {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 188, 212, 0.1);
            border-radius: 10px;
            border-left: 3px solid #00bcd4;
        }

        .insurance-selector label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .total-amount {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .total-amount-label {
            font-size: 1.2em;
            color: #00bcd4;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .total-amount-value {
            font-size: 3.5em;
            font-weight: 800;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(0, 188, 212, 0.6);
        }

        /* Customer Records Styles */
        .customer-info-card {
            background: linear-gradient(135deg, #1e3a5f 0%, #16213e 100%);
            border: 1px solid rgba(0, 188, 212, 0.3);
            display: none; /* Hidden by default */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .customer-info-card h2 {
            color: #00bcd4;
            margin: 0;
            font-size: 1.3em;
        }

        .customer-info-card.show {
            display: block;
        }

        /* Ellipsis Menu Styles */
        .menu-container {
            position: absolute;
            top: 12px;
            right: 15px;
            z-index: 100;
        }

        .ellipsis-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            width: 36px;
            height: 36px;
        }

        .ellipsis-btn::before {
            content: '';
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            box-shadow: 
                0 -8px 0 white,
                0 8px 0 white;
            display: block;
        }

        .ellipsis-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            transform: translateY(-1px);
        }

        .menu-dropdown {
            position: absolute;
            top: 48px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            min-width: 250px;
            display: none;
            overflow: hidden;
        }

        .menu-dropdown.show {
            display: block;
            animation: menuSlideIn 0.3s ease;
        }

        @keyframes menuSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #2c3e50;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: #f8f9fa;
        }

        .menu-item-text {
            font-weight: 500;
        }

        .menu-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .customer-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .customer-form-grid .form-group {
            margin: 0;
        }

        .customer-form-grid .form-group label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        .customer-form-grid .form-group input {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 188, 212, 0.3);
            color: #1a1a2e;
            font-size: 0.95em;
        }

        .customer-form-grid .form-group input:focus {
            border-color: #00bcd4;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.1);
        }

        .save-record-btn {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            font-size: 0.95em;
            box-shadow: 0 4px 10px rgba(0, 188, 212, 0.3);
            transition: all 0.3s ease;
        }

        .save-record-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 188, 212, 0.4);
        }

        .view-records-btn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            font-size: 1em;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .view-records-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(33, 150, 243, 0.4);
        }

        .records-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .records-modal-content {
            background: white;
            margin: 30px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 1200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .close-modal {
            font-size: 2em;
            color: #666;
            cursor: pointer;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .search-box {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            font-size: 1em;
        }

        .record-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #00bcd4;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .record-card:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .record-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .record-date {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .record-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .record-detail-item {
            font-size: 0.9em;
            color: #555;
        }

        .record-detail-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .record-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .load-btn {
            background: #00bcd4;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
        }

        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #00bcd4;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            width: 30px;
            height: 30px;
        }

        .close-btn:hover {
            color: #ff5252;
            transform: rotate(90deg);
        }

        .close-btn::before,
        .close-btn::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background-color: currentColor;
        }

        .close-btn::before {
            transform: rotate(45deg);
        }

        .close-btn::after {
            transform: rotate(-45deg);
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .delete-btn::before {
            content: '';
            display: inline-block;
            width: 14px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='16' viewBox='0 0 14 16'%3E%3Cpath fill='white' d='M11 2H9c0-.55-.45-1-1-1H6c-.55 0-1 .45-1 1H3c-.55 0-1 .45-1 1v1c0 .55.45 1 1 1h8c.55 0 1-.45 1-1V3c0-.55-.45-1-1-1zM4 6v7c0 .55.45 1 1 1h4c.55 0 1-.45 1-1V6H4zm2 6H5V8h1v4zm2 0H7V8h1v4zm2 0H9V8h1v4z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        .load-btn:hover, .delete-btn:hover {
            opacity: 0.8;
        }

        .no-records {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        @media (max-width: 1200px) {
            .calculator-wrapper {
                grid-template-columns: 1fr;
            }
            
            .main-costs-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .result-grid {
                grid-template-columns: 1fr;
            }

            .brand-logo h1 {
                font-size: 1.6em;
            }

            .brand-logo .motoreast {
                font-size: 1.2em;
            }

            .monthly-payment-big {
                font-size: 2.2em;
            }

            .total-amount-value {
                font-size: 2.5em;
            }

            .customer-form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand-logo">
                <h1>BYD</h1>
                <div class="separator"></div>
                <div class="motoreast">MOTOR-EAST</div>
            </div>
            
            <!-- Ellipsis Menu for Sales Personnel -->
            <div class="menu-container">
                <button class="ellipsis-btn" onclick="toggleMenu()" title="Sales Tools"></button>
                <div id="menuDropdown" class="menu-dropdown">
                    <div class="menu-header">Sales Tools</div>
                    <div class="menu-item" onclick="toggleCustomerForm()">
                        
                        <span class="menu-item-text">Customer Information</span>
                    </div>
                    <div class="menu-item" onclick="quickSaveRecord()">
                        
                        <span class="menu-item-text">Save Customer Record</span>
                    </div>
                    <div class="menu-item" onclick="openRecordsModal(); toggleMenu();">
                        
                        <span class="menu-item-text">View Saved Records</span>
                    </div>
                    <div class="menu-item" style="padding: 8px 15px; flex-direction: column; align-items: flex-start; cursor: default;">
                        <span class="menu-item-text" style="margin-bottom: 8px; font-weight: 600;">Pricing Version</span>
                        <select id="pricingVersion" onchange="switchPricingVersion()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 0.9em;">
                            <option value="current">Current (6 Nov - 19 Nov 2025)</option>
                            <option value="previous">Previous (24 Oct - 5 Nov 2025)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Information Card -->
        <div class="card customer-info-card" id="customerInfoCard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h2>Customer Information</h2>
                <button class="close-btn" onclick="toggleCustomerForm()" title="Close"></button>
            </div>
            <div class="customer-form-grid">
                <div class="form-group">
                    <label for="customerName">Customer Name *</label>
                    <input type="text" id="customerName">
                </div>
                <div class="form-group">
                    <label for="customerPhone">Contact Number</label>
                    <input type="text" id="customerPhone">
                </div>
                <div class="form-group">
                    <label for="customerEmail">Email Address</label>
                    <input type="email" id="customerEmail">
                </div>
                <div class="form-group">
                    <label for="customerNotes">Notes</label>
                    <input type="text" id="customerNotes">
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                <button class="save-record-btn" onclick="saveCustomerRecord()">Save Record</button>
            </div>
        </div>

<div class="calculator-wrapper">
            <!-- Left Column - Loan Details -->
            <div class="card">
                <h2>Loan Details</h2>
                
                <div class="form-group">
                    <label for="coeCategory">
                        COE Category 
                        <span class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">
                                <strong>COE Category:</strong><br>
                                <strong>Category A:</strong> Electric up to 110kW<br>
                                <strong>Category B:</strong> Electric above 110kW
                            </span>
                        </span>
                    </label>
                    <select id="coeCategory" onchange="filterVehiclesByCategory()">
                        <option value="">-- Select COE Category --</option>
                        <option value="A">Category A</option>
                        <option value="B">Category B</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="vehicle">Vehicle Model</label>
                    <select id="vehicle" onchange="loadVehicleData()" disabled>
                        <option value="">-- Choose Your BYD Model --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Price Input Mode</label>
                    <div style="display: flex; gap: 15px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9em;">
                            <input type="radio" name="priceMode" value="package" checked onchange="togglePriceMode()">
                            <span>Package Pricing</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9em;">
                            <input type="radio" name="priceMode" value="manual" onchange="togglePriceMode()">
                            <span>Custom Price</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="packageGroup">
                    <label for="packageType">
                        Package Type 
                        <span class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">
                                <strong>Package Types:</strong><br>
                                <strong>Savers:</strong> 8 COE attempts<br>
                                <strong>Base:</strong> 6 COE attempts<br>
                                <strong>Excite:</strong> Guaranteed 4-bid COE
                            </span>
                        </span>
                    </label>
                    <select id="packageType" onchange="updateDownPayment()" disabled>
                        <option value="">-- Select Package --</option>
                    </select>
                </div>

                <div class="form-group" id="manualPriceGroup" style="display: none;">
                    <label for="manualPrice">Selling Price (SGD)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="manualPrice" class="with-prefix" placeholder="Enter selling price" min="0" step="1000" oninput="updateManualDownPayment()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="downPayment" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>
                            Down Payment (SGD) 
                            <span class="tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltiptext">
                                    <strong>Bank Loan Requirements:</strong><br>
                                    Minimum 40% down payment required (exactly 40% qualifies for bank loan)
                                </span>
                            </span>
                        </span>
                        <span class="slider-value" id="percentageDisplay" style="font-weight: 700; color: #00bcd4; font-size: 1.1em;">40%</span>
                    </label>
                    
                    <div class="slider-container">
                        <input type="range" id="downPaymentSlider" min="0" max="100" value="40" step="1" oninput="updateFromSlider()">
                    </div>
                    
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="downPayment" class="with-prefix" placeholder="Enter amount" min="0" step="1000" oninput="updateFromDollar()">
                    </div>
                    <div id="downPaymentInfo" class="down-payment-info">
                        Please enter your down payment amount
                    </div>
                </div>

                <div class="form-group">
                    <label for="interestRate">Interest Rate (% p.a.)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">%</span>
                        <input type="number" id="interestRate" class="with-prefix" value="2.28" step="0.01" min="0" max="10">
                    </div>
                </div>

                <div class="form-group">
                    <label for="loanTerm">
                        Loan Term (Years)
                        <span class="tooltip">
                            <span class="warning-icon">!</span>
                            <span class="tooltiptext">
                                <strong>Bank Loan Requirement:</strong><br>
                                Maximum 7 years for bank loan approval
                            </span>
                        </span>
                    </label>
                    <select id="loanTerm">
                        <option value="1">1 Year (12 months)</option>
                        <option value="2">2 Years (24 months)</option>
                        <option value="3">3 Years (36 months)</option>
                        <option value="4">4 Years (48 months)</option>
                        <option value="5">5 Years (60 months)</option>
                        <option value="6">6 Years (72 months)</option>
                        <option value="7" selected>7 Years (84 months)</option>
                        <option value="8">8 Years (96 months)</option>
                        <option value="9">9 Years (108 months)</option>
                        <option value="10">10 Years (120 months)</option>
                    </select>
                </div>

                <button class="calculate-btn" onclick="calculateLoan()">Calculate Monthly Payment</button>
            </div>

            <!-- Right Column - Loan Summary -->
            <div class="card">
                <h2>Loan Summary</h2>
                
                <div class="result-box">
                    <h3>Monthly Payment</h3>
                    <div class="monthly-payment-big" id="monthlyPayment">$0.00</div>
                    
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">Total Payable</div>
                            <div class="result-value" id="totalPayable">$0.00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Total Interest</div>
                            <div class="result-value" id="totalInterest">$0.00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Loan Amount</div>
                            <div class="result-value" id="loanAmount">$0.00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Selling Price</div>
                            <div class="result-value" id="sellingPrice">$0.00</div>
                        </div>
                    </div>
                </div>

                <div class="breakdown-section">
                    <h3>Price Breakdown</h3>
                    <table class="breakdown-table" id="breakdownTable">
                        <tbody id="breakdownBody">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999; font-size: 0.9em;">
                                    Select a vehicle and click Calculate to see detailed breakdown
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Drive Away Price Card -->
        <div class="closing-costs-card" id="closingCostsCard">
            <div class="closing-costs-header" onclick="toggleClosingCosts()">
                <h2>Drive Away Price</h2>
                <span class="toggle-icon"></span>
            </div>
            
            <div class="closing-costs-content">
                <div class="closing-costs-grid">
                <!-- Main costs in one row -->
                <div class="main-costs-row">
                    <div class="cost-item">
                        <div class="cost-item-label">COE Deposit</div>
                        <div class="cost-item-value">$16,350</div>
                    </div>

                    <div class="cost-item" id="additionalDownPaymentItem" style="display: none;">
                        <div class="cost-item-label">Additional Down Payment</div>
                        <div class="cost-item-value" id="additionalDownPaymentCost">$0</div>
                    </div>

                    <div class="cost-item" id="firstInstallmentItem" style="display: none;">
                        <div class="cost-item-label">First Month Installment</div>
                        <div class="cost-item-value" id="firstInstallmentCost">$0</div>
                    </div>
                </div>

                <!-- Insurance with slider -->
                <div class="cost-item" id="insuranceItem">
                    <div class="cost-item-label">First Month Insurance</div>
                    <div class="cost-item-value" id="insuranceCost">$1,500</div>
                    <div class="insurance-slider-inline">
                        <input type="range" id="insuranceSlider" min="0" max="3000" value="1500" step="50" oninput="updateInsurance()">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #6c757d; margin-top: 3px;">
                            <span>$0</span>
                            <span>$3,000</span>
                        </div>
                    </div>
                </div>

                <!-- Admin fee - subtle -->
                <div class="cost-item subtle" id="adminFeeItem" style="display: none;">
                    <div class="cost-item-label">Admin Fee (Non-Bank Loan)</div>
                    <div class="cost-item-value">$500</div>
                </div>
            </div>

            <div class="total-amount">
                <div class="total-amount-label">Total Amount Required</div>
                <div class="total-amount-value" id="totalClosingCost">$0</div>
            </div>
            </div>
        </div>

        <div class="validity-notice">
            <strong id="validityDates">Valid from 6 Nov - 19 Nov 2025, 12:00 hrs</strong>
            <span>Prices subject to change without notice - Based on latest Motor-East pricing</span>
        </div>
    </div>

    <!-- Customer Records Modal -->
    <div id="recordsModal" class="records-modal">
        <div class="records-modal-content">
            <div class="records-header">
                <h2>Saved Customer Records</h2>
                <span class="close-modal" onclick="closeRecordsModal()">&times;</span>
            </div>
            <input type="text" id="searchRecords" class="search-box" placeholder="Search by customer name, phone, or vehicle..." onkeyup="filterRecords()">
            <div id="recordsList"></div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // IMPORTANT: Replace this with YOUR Firebase config from Firebase Console
        // Get it from: Firebase Console > Project Settings > Your apps > Web app
        
        const firebaseConfig = {
            apiKey: "AIzaSyC0ldnnTvXFtTEwy2pb82c1tOFKaSzSljI",
            authDomain: "byd-motoreast.firebaseapp.com",
            projectId: "byd-motoreast",
            storageBucket: "byd-motoreast.firebasestorage.app",
            messagingSenderId: "957847956351",
            appId: "1:957847956351:web:fef426d8059a2d7df5084a"
        };

        // Initialize Firebase
        let db = null;
        let firebaseInitialized = false;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log("âœ… Firebase connected successfully!");
            } else {
                console.warn("âš ï¸ Firebase not configured. Using localStorage as fallback.");
            }
        } catch (error) {
            console.error("âŒ Firebase initialization error:", error);
            console.warn("Using localStorage as fallback.");
        }

        // ============================================
        // CLOUD DATA FUNCTIONS
        // ============================================
        
        // Save customer record to cloud or localStorage
        async function saveToCloud(record) {
            if (firebaseInitialized && db) {
                try {
                    await db.collection('customers').doc(record.id.toString()).set(record);
                    return true;
                } catch (error) {
                    console.error("Error saving to Firebase:", error);
                    // Fallback to localStorage
                    saveToLocalStorage(record);
                    return false;
                }
            } else {
                // Use localStorage as fallback
                saveToLocalStorage(record);
                return true;
            }
        }

        // Load all customer records from cloud or localStorage
        async function loadFromCloud() {
            if (firebaseInitialized && db) {
                try {
                    const snapshot = await db.collection('customers').orderBy('timestamp', 'desc').get();
                    const records = [];
                    snapshot.forEach(doc => {
                        records.push(doc.data());
                    });
                    return records;
                } catch (error) {
                    console.error("Error loading from Firebase:", error);
                    // Fallback to localStorage
                    return loadFromLocalStorage();
                }
            } else {
                // Use localStorage as fallback
                return loadFromLocalStorage();
            }
        }

        // Delete customer record from cloud or localStorage
        async function deleteFromCloud(recordId) {
            if (firebaseInitialized && db) {
                try {
                    await db.collection('customers').doc(recordId.toString()).delete();
                    return true;
                } catch (error) {
                    console.error("Error deleting from Firebase:", error);
                    // Fallback to localStorage
                    deleteFromLocalStorage(recordId);
                    return false;
                }
            } else {
                // Use localStorage as fallback
                deleteFromLocalStorage(recordId);
                return true;
            }
        }

        // ============================================
        // LOCALSTORAGE FALLBACK FUNCTIONS
        // ============================================
        
        function saveToLocalStorage(record) {
            let records = JSON.parse(localStorage.getItem('bydCustomerRecords') || '[]');
            const existingIndex = records.findIndex(r => r.id === record.id);
            if (existingIndex >= 0) {
                records[existingIndex] = record;
            } else {
                records.unshift(record);
            }
            localStorage.setItem('bydCustomerRecords', JSON.stringify(records));
        }

        function loadFromLocalStorage() {
            return JSON.parse(localStorage.getItem('bydCustomerRecords') || '[]');
        }

        function deleteFromLocalStorage(recordId) {
            let records = JSON.parse(localStorage.getItem('bydCustomerRecords') || '[]');
            records = records.filter(r => r.id !== recordId);
            localStorage.setItem('bydCustomerRecords', JSON.stringify(records));
        }

        // ============================================
        // VEHICLE DATA
        // ============================================
        
        let currentVehicleData = null;

        // Pricing Databases
        const currentPricing = {
            dolphin: {
                name: "BYD Dolphin Premium",
                displayName: "Dolphin Premium (15.9 kWh/100km)",
                coeCategory: "A",
                listPrice: 241888,
                packages: {
                    savers: 166888,
                    base: 171888,
                    excite: 176888
                }
            },
            atto2: {
                name: "BYD Atto 2 Extended",
                displayName: "Atto 2 Extended (17.0 kWh/100km)",
                coeCategory: "A",
                listPrice: 234888,
                packages: {
                    savers: 159888,
                    base: 164888,
                    excite: 169888
                }
            },
            atto3_ext: {
                name: "BYD Atto 3 Extended",
                displayName: "Atto 3 Extended (16 kWh/100km)",
                coeCategory: "A",
                listPrice: 248888,
                packages: {
                    savers: 173888,
                    base: 178888,
                    excite: 183888
                }
            },
            atto3_ce: {
                name: "BYD Atto 3 Carbon Edge",
                displayName: "Atto 3 Carbon Edge (16 kWh/100km)",
                coeCategory: "A",
                listPrice: 252888,
                packages: {
                    savers: 177888,
                    base: 182888,
                    excite: 187888
                }
            },
            m6_7s: {
                name: "BYD M6 7-Seater",
                displayName: "M6 7-Seater (18.7 kWh/100km)",
                coeCategory: "A",
                listPrice: 253388,
                packages: {
                    savers: 178388,
                    base: 183388,
                    excite: 188388
                }
            },
            m6_ce: {
                name: "BYD M6 Carbon Edge",
                displayName: "M6 Carbon Edge (18.7 kWh/100km)",
                coeCategory: "A",
                listPrice: 256388,
                packages: {
                    savers: 181388,
                    base: 186388,
                    excite: 191388
                }
            },
            seal6_prem_a: {
                name: "BYD Seal 6 EV Premium",
                displayName: "Seal 6 EV Premium (15.2 kWh/100km)",
                coeCategory: "A",
                listPrice: 241388,
                packages: {
                    savers: 166388,
                    base: 171388,
                    excite: 176388
                }
            },
            seal_dyn: {
                name: "BYD Seal Dynamic 100kW",
                displayName: "Seal Dynamic 100kW (15.4 kWh/100km)",
                coeCategory: "A",
                listPrice: 259388,
                packages: {
                    savers: 184388,
                    base: 189388,
                    excite: 194388
                }
            },
            seal_prem_b: {
                name: "BYD Seal Premium",
                displayName: "Seal Premium (16.6 kWh/100km)",
                coeCategory: "B",
                listPrice: 270388,
                packages: {
                    savers: 195388,
                    base: 200388,
                    excite: 210388
                }
            },
            seal_perf_b: {
                name: "BYD Seal Performance",
                displayName: "Seal Performance (18.2 kWh/100km)",
                coeCategory: "B",
                listPrice: 321888,
                packages: {
                    savers: 246888,
                    base: 251888,
                    excite: 260888
                }
            },
            sealion6_dmi: {
                name: "BYD Sealion 6 DM-i",
                displayName: "Sealion 6 DM-i (18.8kWh/100km, 0.9l/100km)",
                coeCategory: "B",
                listPrice: 277388,
                packages: {
                    savers: 202388,
                    base: 207388,
                    excite: 217388
                }
            },
            sealion7_dyn: {
                name: "BYD Sealion 7 Dynamic 100kW",
                displayName: "Sealion 7 Dynamic 100kW (18.8 kWh/100km)",
                coeCategory: "A",
                listPrice: 267388,
                packages: {
                    savers: 192388,
                    base: 197388,
                    excite: 202388
                }
            },
            sealion7_prem: {
                name: "BYD Sealion 7 Premium",
                displayName: "Sealion 7 Premium (19.9 kWh/100km)",
                coeCategory: "B",
                listPrice: 272388,
                packages: {
                    savers: 197388,
                    base: 202388,
                    excite: 212388
                }
            },
            sealion7_perf: {
                name: "BYD Sealion 7 Performance",
                displayName: "Sealion 7 Performance (21.4 kWh/100km)",
                coeCategory: "B",
                listPrice: 297388,
                packages: {
                    savers: 222388,
                    base: 227388,
                    excite: 237388
                }
            },
            sealion7_dmi_prem: {
                name: "BYD Sealion 7 DM-i Premium",
                displayName: "Sealion 7 DM-i Premium (16.6 kWh/100km)",
                coeCategory: "B",
                listPrice: 321888,
                packages: {
                    savers: 246888,
                    base: 251888,
                    excite: 260888
                }
            }
        };

        const previousPricing = {
            dolphin: {
                name: "BYD Dolphin Premium",
                displayName: "Dolphin Premium (15.9 kWh/100km)",
                coeCategory: "A",
                listPrice: 253888,
                packages: {
                    savers: 178888,
                    base: 183888,
                    excite: 188888
                }
            },
            atto2: {
                name: "BYD Atto 2 Extended",
                displayName: "Atto 2 Extended (17.0 kWh/100km)",
                coeCategory: "A",
                listPrice: 246888,
                packages: {
                    savers: 171888,
                    base: 176888,
                    excite: 181888
                }
            },
            atto3_ext: {
                name: "BYD Atto 3 Extended",
                displayName: "Atto 3 Extended (16 kWh/100km)",
                coeCategory: "A",
                listPrice: 260888,
                packages: {
                    savers: 185888,
                    base: 190888,
                    excite: 195888
                }
            },
            atto3_ce: {
                name: "BYD Atto 3 Carbon Edge",
                displayName: "Atto 3 Carbon Edge (16 kWh/100km)",
                coeCategory: "A",
                listPrice: 264888,
                packages: {
                    savers: 189888,
                    base: 194888,
                    excite: 199888
                }
            },
            m6_7s: {
                name: "BYD M6 7-Seater",
                displayName: "M6 7-Seater (18.7 kWh/100km)",
                coeCategory: "A",
                listPrice: 265388,
                packages: {
                    savers: 190388,
                    base: 195388,
                    excite: 200388
                }
            },
            m6_ce: {
                name: "BYD M6 Carbon Edge",
                displayName: "M6 Carbon Edge (18.7 kWh/100km)",
                coeCategory: "A",
                listPrice: 268388,
                packages: {
                    savers: 193388,
                    base: 198388,
                    excite: 203388
                }
            },
            seal6_prem_a: {
                name: "BYD Seal 6 EV Premium",
                displayName: "Seal 6 EV Premium (15.2 kWh/100km)",
                coeCategory: "A",
                listPrice: 253388,
                packages: {
                    savers: 178388,
                    base: 183388,
                    excite: 188388
                }
            },
            seal_dyn: {
                name: "BYD Seal Dynamic 100kW",
                displayName: "Seal Dynamic 100kW (15.4 kWh/100km)",
                coeCategory: "A",
                listPrice: 271388,
                packages: {
                    savers: 196388,
                    base: 201388,
                    excite: 206388
                }
            },
            seal_prem_b: {
                name: "BYD Seal Premium",
                displayName: "Seal Premium (16.6 kWh/100km)",
                coeCategory: "B",
                listPrice: 287388,
                packages: {
                    savers: 212388,
                    base: 217388,
                    excite: 227388
                }
            },
            sealion6_dmi: {
                name: "BYD Sealion 6 DM-i",
                displayName: "Sealion 6 DM-i (18.8kWh/100km, 0.9l/100km)",
                coeCategory: "B",
                listPrice: 294388,
                packages: {
                    savers: 219388,
                    base: 224388,
                    excite: 234388
                }
            },
            sealion7_dyn: {
                name: "BYD Sealion 7 Dynamic 100kW",
                displayName: "Sealion 7 Dynamic 100kW (18.8 kWh/100km)",
                coeCategory: "A",
                listPrice: 283388,
                packages: {
                    savers: 208388,
                    base: 213388,
                    excite: 218388
                }
            },
            sealion7_prem: {
                name: "BYD Sealion 7 Premium",
                displayName: "Sealion 7 Premium (19.9 kWh/100km)",
                coeCategory: "B",
                listPrice: 289388,
                packages: {
                    savers: 214388,
                    base: 219388,
                    excite: 229388
                }
            },
            sealion7_perf: {
                name: "BYD Sealion 7 Performance",
                displayName: "Sealion 7 Performance (21.4 kWh/100km)",
                coeCategory: "B",
                listPrice: 314388,
                packages: {
                    savers: 239388,
                    base: 244388,
                    excite: 254388
                }
            }
        };

        // Active pricing database
        let vehicleDatabase = currentPricing;

        function switchPricingVersion() {
            const version = document.getElementById('pricingVersion').value;
            const validityDates = document.getElementById('validityDates');
            
            // Switch the active pricing database
            if (version === 'current') {
                vehicleDatabase = currentPricing;
                validityDates.textContent = 'Valid from 6 Nov - 19 Nov 2025, 12:00 hrs';
            } else {
                vehicleDatabase = previousPricing;
                validityDates.textContent = 'Valid from 24 Oct - 5 Nov 2025, 12:00 hrs';
            }
            
            // Reset all selections and reload the form
            document.getElementById('coeCategory').value = '';
            document.getElementById('vehicle').value = '';
            document.getElementById('vehicle').disabled = true;
            document.getElementById('packageType').value = '';
            document.getElementById('packageType').disabled = true;
            document.getElementById('packageType').innerHTML = '<option value="">-- Select Package --</option>';
            document.getElementById('downPayment').value = '';
            document.getElementById('manualPrice').value = '';
            document.getElementById('downPaymentInfo').innerHTML = 'Please enter your down payment amount';
            
            // Hide closing costs
            document.getElementById('closingCostsCard').classList.remove('show');
            
            // Clear current vehicle data
            currentVehicleData = null;
            
            // Clear vehicle select options
            const vehicleSelect = document.getElementById('vehicle');
            vehicleSelect.innerHTML = '<option value="">-- Choose Your BYD Model --</option>';
            
            console.log(`Switched to ${version} pricing`);
        }

        function filterVehiclesByCategory() {
            const selectedCategory = document.getElementById('coeCategory').value;
            const vehicleSelect = document.getElementById('vehicle');
            const packageSelect = document.getElementById('packageType');
            
            vehicleSelect.value = '';
            currentVehicleData = null;
            
            packageSelect.value = '';
            packageSelect.disabled = true;
            packageSelect.innerHTML = '<option value="">-- Select Package --</option>';
            document.getElementById('downPayment').value = '';
            document.getElementById('manualPrice').value = '';
            document.getElementById('downPaymentInfo').innerHTML = 'Please enter your down payment amount';
            
            // Hide closing costs
            document.getElementById('closingCostsCard').classList.remove('show');
            
            vehicleSelect.innerHTML = '<option value="">-- Choose Your BYD Model --</option>';
            
            if (!selectedCategory) {
                vehicleSelect.disabled = true;
                return;
            }
            
            vehicleSelect.disabled = false;
            
            Object.keys(vehicleDatabase).forEach(key => {
                const vehicle = vehicleDatabase[key];
                if (vehicle.coeCategory === selectedCategory) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = vehicle.displayName;
                    vehicleSelect.appendChild(option);
                }
            });
        }

        function loadVehicleData() {
            const vehicleId = document.getElementById('vehicle').value;
            const packageSelect = document.getElementById('packageType');
            
            if (vehicleId && vehicleDatabase[vehicleId]) {
                currentVehicleData = vehicleDatabase[vehicleId];
                
                packageSelect.disabled = false;
                packageSelect.innerHTML = `
                    <option value="">-- Select Package --</option>
                    <option value="savers">Savers (8-Bid COE) - $${currentVehicleData.packages.savers.toLocaleString()}</option>
                    <option value="base">Base (6-Bid COE) - $${currentVehicleData.packages.base.toLocaleString()}</option>
                    <option value="excite">Excite (Guaranteed 4-Bid COE) - $${currentVehicleData.packages.excite.toLocaleString()}</option>
                `;
                
                document.getElementById('downPayment').value = '';
                document.getElementById('downPaymentInfo').innerHTML = 'Please enter your down payment amount';
            } else {
                currentVehicleData = null;
                packageSelect.disabled = true;
                packageSelect.innerHTML = '<option value="">-- Select Package --</option>';
            }
        }

        function updateDownPayment() {
            const packageType = document.getElementById('packageType').value;
            if (packageType && currentVehicleData) {
                const sellingPrice = currentVehicleData.packages[packageType];
                const suggestedDownPayment = Math.round(sellingPrice * 0.40);
                
                document.getElementById('downPayment').value = suggestedDownPayment;
                
                const slider = document.getElementById('downPaymentSlider');
                slider.value = 40;
                document.getElementById('percentageDisplay').textContent = '40%';
                
                const progress = 40;
                slider.style.background = `linear-gradient(to right, #00bcd4 0%, #00bcd4 ${progress}%, #e0e0e0 ${progress}%, #e0e0e0 100%)`;
                
                const downPaymentInfo = document.getElementById('downPaymentInfo');
                const loanTerm = parseInt(document.getElementById('loanTerm').value) || 7;
                
                let infoMessage = `Suggested: $${suggestedDownPayment.toLocaleString()} (40%)`;
                
                if (loanTerm <= 7) {
                    infoMessage += ' - Qualifies for bank loan - You may adjust as needed';
                } else {
                    infoMessage += ' - Down payment OK, but reduce loan term to 7 years or less for bank loan';
                }
                
                downPaymentInfo.innerHTML = infoMessage;
            }
        }

        function togglePriceMode() {
            const priceMode = document.querySelector('input[name="priceMode"]:checked').value;
            const packageGroup = document.getElementById('packageGroup');
            const manualPriceGroup = document.getElementById('manualPriceGroup');
            const packageSelect = document.getElementById('packageType');
            const manualPriceInput = document.getElementById('manualPrice');
            
            if (priceMode === 'manual') {
                packageGroup.style.display = 'none';
                manualPriceGroup.style.display = 'block';
                packageSelect.disabled = true;
                
                const packageType = packageSelect.value;
                if (packageType && currentVehicleData) {
                    const sellingPrice = currentVehicleData.packages[packageType];
                    manualPriceInput.value = sellingPrice;
                    updateManualDownPayment();
                }
            } else {
                packageGroup.style.display = 'block';
                manualPriceGroup.style.display = 'none';
                
                if (currentVehicleData) {
                    packageSelect.disabled = false;
                }
                
                if (packageSelect.value) {
                    updateDownPayment();
                }
            }
        }

        function updateManualDownPayment() {
            const manualPrice = parseFloat(document.getElementById('manualPrice').value) || 0;
            if (manualPrice > 0) {
                const suggestedDownPayment = Math.round(manualPrice * 0.40);
                document.getElementById('downPayment').value = suggestedDownPayment;
                
                const downPaymentInfo = document.getElementById('downPaymentInfo');
                const loanTerm = parseInt(document.getElementById('loanTerm').value) || 7;
                
                let infoMessage = `Suggested: $${suggestedDownPayment.toLocaleString()} (40%)`;
                
                if (loanTerm <= 7) {
                    infoMessage += ' - Qualifies for bank loan - You may adjust as needed';
                } else {
                    infoMessage += ' - Down payment OK, but reduce loan term to 7 years or less for bank loan';
                }
                
                downPaymentInfo.innerHTML = infoMessage;
                
                updateSliderFromDollar();
            } else {
                document.getElementById('downPaymentInfo').innerHTML = 'Please enter a selling price first';
            }
        }

        function updateFromSlider() {
            const slider = document.getElementById('downPaymentSlider');
            const percentage = parseInt(slider.value);
            document.getElementById('percentageDisplay').textContent = percentage + '%';
            
            const progress = percentage;
            slider.style.background = `linear-gradient(to right, #00bcd4 0%, #00bcd4 ${progress}%, #e0e0e0 ${progress}%, #e0e0e0 100%)`;
            
            const priceMode = document.querySelector('input[name="priceMode"]:checked').value;
            let sellingPrice = 0;
            
            if (priceMode === 'manual') {
                sellingPrice = parseFloat(document.getElementById('manualPrice').value) || 0;
            } else {
                const packageType = document.getElementById('packageType').value;
                if (packageType && currentVehicleData) {
                    sellingPrice = currentVehicleData.packages[packageType];
                }
            }
            
            if (sellingPrice > 0) {
                const downPayment = Math.round(sellingPrice * (percentage / 100));
                document.getElementById('downPayment').value = downPayment;
                
                const downPaymentInfo = document.getElementById('downPaymentInfo');
                const loanTerm = parseInt(document.getElementById('loanTerm').value) || 7;
                
                // Provide helpful guidance based on bank loan eligibility
                let infoMessage = `$${downPayment.toLocaleString()} (${percentage}%)`;
                
                // Use same rounding logic as eligibility check
                const actualPercentage = (downPayment / sellingPrice) * 100;
                const roundedPercentage = Math.round(actualPercentage * 10) / 10;
                
                if (roundedPercentage >= 40.0 && loanTerm <= 7) {
                    infoMessage += ' - Qualifies for bank loan';
                } else if (roundedPercentage < 40.0) {
                    const needed = Math.ceil(sellingPrice * 0.40) - downPayment;
                    infoMessage += ` - Need $${needed.toLocaleString()} more for bank loan (40% minimum)`;
                } else if (loanTerm > 7) {
                    infoMessage += ' - Down payment OK, but loan term must be 7 years or less for bank loan';
                }
                
                downPaymentInfo.innerHTML = infoMessage;
            }
            
            // Update closing costs when down payment changes
            if (document.getElementById('closingCostsCard').classList.contains('show')) {
                calculateClosingCosts();
            }
        }

        function updateFromDollar() {
            updateSliderFromDollar();
        }

        function updateSliderFromDollar() {
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            
            const priceMode = document.querySelector('input[name="priceMode"]:checked').value;
            let sellingPrice = 0;
            
            if (priceMode === 'manual') {
                sellingPrice = parseFloat(document.getElementById('manualPrice').value) || 0;
            } else {
                const packageType = document.getElementById('packageType').value;
                if (packageType && currentVehicleData) {
                    sellingPrice = currentVehicleData.packages[packageType];
                }
            }
            
            if (sellingPrice > 0 && downPayment > 0) {
                const percentage = (downPayment / sellingPrice) * 100;
                const clampedPercentage = Math.max(0, Math.min(100, percentage));
                const displayPercentage = Math.round(clampedPercentage);
                
                const slider = document.getElementById('downPaymentSlider');
                slider.value = displayPercentage;
                document.getElementById('percentageDisplay').textContent = displayPercentage + '%';
                
                const progress = displayPercentage;
                slider.style.background = `linear-gradient(to right, #00bcd4 0%, #00bcd4 ${progress}%, #e0e0e0 ${progress}%, #e0e0e0 100%)`;
                
                const downPaymentInfo = document.getElementById('downPaymentInfo');
                const loanTerm = parseInt(document.getElementById('loanTerm').value) || 7;
                
                // Use same rounding logic as eligibility check
                const roundedPercentage = Math.round(percentage * 10) / 10;
                
                // Provide helpful guidance based on bank loan eligibility
                let infoMessage = `$${downPayment.toLocaleString()} (${roundedPercentage.toFixed(1)}%)`;
                
                if (roundedPercentage >= 40.0 && loanTerm <= 7) {
                    infoMessage += ' - Qualifies for bank loan';
                } else if (roundedPercentage < 40.0) {
                    const needed = Math.ceil(sellingPrice * 0.40) - downPayment;
                    infoMessage += ` - Need $${needed.toLocaleString()} more for bank loan (40% minimum)`;
                } else if (loanTerm > 7) {
                    infoMessage += ' - Down payment OK, but loan term must be 7 years or less for bank loan';
                }
                
                downPaymentInfo.innerHTML = infoMessage;
            }
            
            // Update closing costs when down payment changes
            if (document.getElementById('closingCostsCard').classList.contains('show')) {
                calculateClosingCosts();
            }
        }

        function updateInsurance() {
            const slider = document.getElementById('insuranceSlider');
            const amount = parseInt(slider.value);
            
            document.getElementById('insuranceCost').textContent = `$${amount.toLocaleString()}`;
            
            // Recalculate total
            calculateClosingCosts();
        }

        function updateInsuranceSubsidy() {
            const insurance = parseInt(document.getElementById('insuranceSlider').value);
            const subsidy = parseInt(document.getElementById('insuranceSubsidy').value) || 0;
            const netInsurance = Math.max(0, insurance - subsidy);
            
            // Limit subsidy to insurance amount
            if (subsidy > insurance) {
                document.getElementById('insuranceSubsidy').value = insurance;
                document.getElementById('netInsuranceDisplay').textContent = '$0';
                document.getElementById('insuranceCost').textContent = '$0';
            } else {
                document.getElementById('netInsuranceDisplay').textContent = `$${netInsurance.toLocaleString()}`;
                document.getElementById('insuranceCost').textContent = `$${netInsurance.toLocaleString()}`;
            }
            
            // Show breakdown if subsidy exists
            updateInsuranceBreakdown(insurance, subsidy, netInsurance);
            
            // Recalculate total
            calculateClosingCosts();
        }

        function updateInsuranceBreakdown(insurance, subsidy, netInsurance) {
            const breakdown = document.getElementById('insuranceBreakdown');
            const original = document.getElementById('insuranceOriginal');
            const subsidyDisplay = document.getElementById('insuranceSubsidyDisplay');
            
            if (subsidy > 0) {
                breakdown.style.display = 'block';
                original.textContent = `Original: $${insurance.toLocaleString()} `;
                subsidyDisplay.textContent = `- Subsidy: $${subsidy.toLocaleString()}`;
            } else {
                breakdown.style.display = 'none';
            }
        }

        function calculateLoan() {
            const priceMode = document.querySelector('input[name="priceMode"]:checked').value;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const loanTerm = parseInt(document.getElementById('loanTerm').value) || 7;

            let sellingPrice;
            
            if (priceMode === 'manual') {
                sellingPrice = parseFloat(document.getElementById('manualPrice').value) || 0;
                if (sellingPrice <= 0) {
                    alert('Please enter a valid selling price');
                    return;
                }
                if (!currentVehicleData) {
                    alert('Please select a vehicle first');
                    return;
                }
            } else {
                const packageType = document.getElementById('packageType').value;
                if (!packageType || !currentVehicleData) {
                    alert('Please select a vehicle and package first');
                    return;
                }
                sellingPrice = currentVehicleData.packages[packageType];
            }

            const loanAmount = sellingPrice - downPayment;

            if (loanAmount <= 0) {
                alert('Loan amount must be greater than zero. Please reduce your down payment.');
                return;
            }

            if (loanAmount >= sellingPrice) {
                alert('Down payment must be greater than zero.');
                return;
            }

            const months = loanTerm * 12;
            const flatInterest = loanAmount * (interestRate / 100) * loanTerm;
            const totalPayable = loanAmount + flatInterest;
            const monthlyPayment = totalPayable / months;
            const totalInterest = flatInterest;
            const ltvRatio = (loanAmount / sellingPrice * 100).toFixed(1);

            // Update loan summary
            document.getElementById('monthlyPayment').textContent = `$${monthlyPayment.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalPayable').textContent = `$${totalPayable.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalInterest').textContent = `$${totalInterest.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('loanAmount').textContent = `$${loanAmount.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('sellingPrice').textContent = `$${sellingPrice.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            // Update price breakdown
            updatePriceBreakdown(priceMode, sellingPrice, downPayment, loanAmount, ltvRatio);

            // Show and calculate closing costs
            showClosingCosts(monthlyPayment, downPayment, sellingPrice, loanTerm);
        }

        function updatePriceBreakdown(priceMode, sellingPrice, downPayment, loanAmount, ltvRatio) {
            const breakdownBody = document.getElementById('breakdownBody');
            
            const financeRebate = 6000;
            const insuranceRebate = 4000;
            const tradeinRebate = 6000;
            const promotion = 54000;
            const baseRebatesTotal = financeRebate + insuranceRebate + tradeinRebate + promotion;
            
            if (priceMode === 'manual') {
                const totalPriceReduction = currentVehicleData.listPrice - sellingPrice;
                const specialDiscount = totalPriceReduction - baseRebatesTotal;
                
                let breakdownHTML = `
                    <tr>
                        <td>List Price</td>
                        <td>$${currentVehicleData.listPrice.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr>
                        <td>Less: Finance Rebates</td>
                        <td class="green-text">-$${financeRebate.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr>
                        <td>Less: Insurance Rebates</td>
                        <td class="green-text">-$${insuranceRebate.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr>
                        <td>Less: Trade-in Rebates</td>
                        <td class="green-text">-$${tradeinRebate.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr>
                        <td>Less: Promotion</td>
                        <td class="green-text">-$${promotion.toLocaleString('en-SG')}</td>
                    </tr>
                `;
                
                if (specialDiscount !== 0) {
                    if (specialDiscount > 0) {
                        breakdownHTML += `
                    <tr>
                        <td>Less: Price Adjustment</td>
                        <td class="green-text">-$${specialDiscount.toLocaleString('en-SG')}</td>
                    </tr>
                        `;
                    } else {
                        breakdownHTML += `
                    <tr>
                        <td>Add: Price Adjustment</td>
                        <td style="color: #e74c3c;">+$${Math.abs(specialDiscount).toLocaleString('en-SG')}</td>
                    </tr>
                        `;
                    }
                }
                
                breakdownHTML += `
                    <tr>
                        <td><strong>Selling Price</strong></td>
                        <td><strong>$${sellingPrice.toLocaleString('en-SG')}</strong></td>
                    </tr>
                    <tr>
                        <td>Less: Down Payment (${(downPayment/sellingPrice*100).toFixed(1)}%)</td>
                        <td class="orange-text">-$${downPayment.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr class="highlight-row">
                        <td><strong>Loan Amount (LTV: ${ltvRatio}%)</strong></td>
                        <td><strong>$${loanAmount.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    </tr>
                `;
                
                breakdownBody.innerHTML = breakdownHTML;
            } else {
                const packageType = document.getElementById('packageType').value;
                const coeCategory = currentVehicleData.coeCategory;
                const excitePremium = coeCategory === 'B' ? 10000 : 5000;
                const saversDiscount = 5000;
                
                let breakdownHTML = `
                    <tr>
                        <td>List Price</td>
                        <td>$${currentVehicleData.listPrice.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr>
                        <td>Less: Finance Rebates</td>
                        <td class="green-text">-$${financeRebate.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr>
                        <td>Less: Insurance Rebates</td>
                        <td class="green-text">-$${insuranceRebate.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr>
                        <td>Less: Trade-in Rebates</td>
                        <td class="green-text">-$${tradeinRebate.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr>
                        <td>Less: Promotion</td>
                        <td class="green-text">-$${promotion.toLocaleString('en-SG')}</td>
                    </tr>
                `;
                
                let expectedPrice = currentVehicleData.listPrice - baseRebatesTotal;
                
                if (packageType === 'savers') {
                    breakdownHTML += `
                    <tr>
                        <td>Less: Savers Package Discount</td>
                        <td class="green-text">-$${saversDiscount.toLocaleString('en-SG')}</td>
                    </tr>
                    `;
                    expectedPrice -= saversDiscount;
                } else if (packageType === 'excite') {
                    breakdownHTML += `
                    <tr>
                        <td>Add: Excite Package Premium</td>
                        <td style="color: #e74c3c;">+$${excitePremium.toLocaleString('en-SG')}</td>
                    </tr>
                    `;
                    expectedPrice += excitePremium;
                }
                
                const priceAdjustment = expectedPrice - sellingPrice;
                
                if (priceAdjustment !== 0) {
                    if (priceAdjustment > 0) {
                        breakdownHTML += `
                    <tr>
                        <td>Less: Price Adjustment</td>
                        <td class="green-text">-$${priceAdjustment.toLocaleString('en-SG')}</td>
                    </tr>
                        `;
                    } else {
                        breakdownHTML += `
                    <tr>
                        <td>Add: Price Adjustment</td>
                        <td style="color: #e74c3c;">+$${Math.abs(priceAdjustment).toLocaleString('en-SG')}</td>
                    </tr>
                        `;
                    }
                }
                
                breakdownHTML += `
                    <tr>
                        <td><strong>Selling Price</strong></td>
                        <td><strong>$${sellingPrice.toLocaleString('en-SG')}</strong></td>
                    </tr>
                    <tr>
                        <td>Less: Down Payment (${(downPayment/sellingPrice*100).toFixed(1)}%)</td>
                        <td class="orange-text">-$${downPayment.toLocaleString('en-SG')}</td>
                    </tr>
                    <tr class="highlight-row">
                        <td><strong>Loan Amount (LTV: ${ltvRatio}%)</strong></td>
                        <td><strong>$${loanAmount.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    </tr>
                `;
                
                breakdownBody.innerHTML = breakdownHTML;
            }
        }

        function toggleClosingCosts() {
            const closingCostsCard = document.getElementById('closingCostsCard');
            closingCostsCard.classList.toggle('expanded');
        }

        function showClosingCosts(monthlyPayment, downPayment, sellingPrice, loanTerm) {
            const closingCostsCard = document.getElementById('closingCostsCard');
            const adminFeeItem = document.getElementById('adminFeeItem');
            const firstInstallmentItem = document.getElementById('firstInstallmentItem');
            const firstInstallmentCost = document.getElementById('firstInstallmentCost');

            // Check bank loan eligibility
            // Bank loan requires: Down payment >= 40% (exactly 40% qualifies) AND loan term <= 7 years
            const downPaymentPercentage = (downPayment / sellingPrice) * 100;
            // Round to 1 decimal place to avoid floating point precision issues
            const roundedPercentage = Math.round(downPaymentPercentage * 10) / 10;
            const meetsDownPaymentRequirement = roundedPercentage >= 40.0;
            const meetsLoanTenureRequirement = loanTerm <= 7;
            const isBankLoanEligible = meetsDownPaymentRequirement && meetsLoanTenureRequirement;

            // Show/hide admin fee and first installment based on bank loan eligibility
            if (isBankLoanEligible) {
                // Bank loan eligible - no admin fee or advance payment needed
                adminFeeItem.style.display = 'none';
                firstInstallmentItem.style.display = 'none';
            } else {
                // Not bank loan eligible - show admin fee and first installment
                adminFeeItem.style.display = 'block';
                firstInstallmentItem.style.display = 'block';
                firstInstallmentCost.textContent = `$${monthlyPayment.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }

            // Calculate and show closing costs
            calculateClosingCosts();

            // Show the card collapsed by default - remove 'expanded' class and add 'show' class
            closingCostsCard.classList.remove('expanded');
            closingCostsCard.classList.add('show');
        }

        function calculateClosingCosts() {
            const deposit = 16350;
            const insurance = parseInt(document.getElementById('insuranceSlider').value);
            
            // Get the current down payment
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            
            // Calculate additional down payment (if down payment > deposit)
            const additionalDownPayment = Math.max(0, downPayment - deposit);
            
            // Show/hide additional down payment item
            const additionalDownPaymentItem = document.getElementById('additionalDownPaymentItem');
            const additionalDownPaymentCost = document.getElementById('additionalDownPaymentCost');
            
            if (additionalDownPayment > 0) {
                additionalDownPaymentItem.style.display = 'block';
                additionalDownPaymentCost.textContent = `$${additionalDownPayment.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            } else {
                additionalDownPaymentItem.style.display = 'none';
            }
            
            // Check if admin fee and first installment are shown
            const adminFeeItem = document.getElementById('adminFeeItem');
            const firstInstallmentItem = document.getElementById('firstInstallmentItem');
            
            let totalCost = deposit + insurance + additionalDownPayment;
            
            if (adminFeeItem.style.display !== 'none') {
                totalCost += 500; // Admin fee
                const firstInstallment = parseFloat(document.getElementById('firstInstallmentCost').textContent.replace(/[$,]/g, ''));
                totalCost += firstInstallment;
            }
            
            document.getElementById('totalClosingCost').textContent = `$${totalCost.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // ==================== CUSTOMER RECORDS MANAGEMENT ====================
        
        // Menu and UI Functions
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('show');
        }

        function toggleCustomerForm() {
            const customerCard = document.getElementById('customerInfoCard');
            customerCard.classList.toggle('show');
            
            // Close menu if open
            const menu = document.getElementById('menuDropdown');
            menu.classList.remove('show');
            
            // Smooth scroll to the customer form if showing
            if (customerCard.classList.contains('show')) {
                customerCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function quickSaveRecord() {
            // Close menu
            toggleMenu();
            
            // If customer form is not visible, show it
            const customerCard = document.getElementById('customerInfoCard');
            if (!customerCard.classList.contains('show')) {
                customerCard.classList.add('show');
                customerCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Focus on customer name field
                setTimeout(() => {
                    document.getElementById('customerName').focus();
                }, 300);
            } else {
                // If form is already visible, just save
                saveCustomerRecord();
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('menuDropdown');
            const menuBtn = document.querySelector('.ellipsis-btn');
            
            if (menu && menuBtn && !menu.contains(event.target) && !menuBtn.contains(event.target)) {
                menu.classList.remove('show');
            }
        });
        
        function saveCustomerRecord() {
            // Get customer information
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const customerNotes = document.getElementById('customerNotes').value.trim();

            // Validate required fields
            if (!customerName) {
                alert('Please enter customer name before saving.');
                return;
            }

            // Get all loan calculation data
            const coeCategory = document.getElementById('coeCategory').value;
            const vehicleSelect = document.getElementById('vehicle');
            const vehicle = vehicleSelect.value;
            const vehicleName = vehicleSelect.options[vehicleSelect.selectedIndex].text;
            
            if (!vehicle || !currentVehicleData) {
                alert('Please select a vehicle and calculate the loan before saving.');
                return;
            }

            const priceMode = document.querySelector('input[name="priceMode"]:checked').value;
            const packageType = document.getElementById('packageType').value;
            const sellingPrice = priceMode === 'manual' ? 
                parseFloat(document.getElementById('manualPrice').value) || 0 :
                (currentVehicleData?.packages?.[packageType] || 0);
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const loanTerm = parseInt(document.getElementById('loanTerm').value) || 0;
            
            // Get calculated values
            const monthlyPayment = document.getElementById('monthlyPayment').textContent;
            const totalPayable = document.getElementById('totalPayable').textContent;
            const totalInterest = document.getElementById('totalInterest').textContent;
            const loanAmount = document.getElementById('loanAmount').textContent;

            // Get current pricing version
            const currentPricingVersion = document.getElementById('pricingVersion').value;
            
            // Create record object
            const record = {
                id: Date.now(), // Unique ID
                timestamp: new Date().toISOString(),
                pricingVersion: currentPricingVersion, // Save which pricing was used
                customer: {
                    name: customerName,
                    phone: customerPhone,
                    email: customerEmail,
                    notes: customerNotes
                },
                vehicle: {
                    model: vehicle,
                    name: vehicleName,
                    coeCategory: coeCategory
                },
                loan: {
                    priceMode: priceMode,
                    packageType: packageType,
                    sellingPrice: sellingPrice,
                    downPayment: downPayment,
                    interestRate: interestRate,
                    loanTerm: loanTerm,
                    monthlyPayment: monthlyPayment,
                    totalPayable: totalPayable,
                    totalInterest: totalInterest,
                    loanAmount: loanAmount
                }
            };

            // Save to cloud (Firebase) or localStorage as fallback
            saveToCloud(record).then(success => {
                const storageType = firebaseInitialized ? 'â˜ï¸ Cloud' : 'ðŸ’¾ Local';
                
                // Show success message
                alert(`âœ… Customer record saved to ${storageType}!\n\nCustomer: ${customerName}\nVehicle: ${vehicleName}\nMonthly Payment: ${monthlyPayment}`);
                
                // Automatically clear customer form fields for next customer
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerEmail').value = '';
                document.getElementById('customerNotes').value = '';
            });
        }

        function openRecordsModal() {
            document.getElementById('recordsModal').style.display = 'block';
            displayRecords();
        }

        function closeRecordsModal() {
            document.getElementById('recordsModal').style.display = 'none';
        }

        async function displayRecords(searchTerm = '') {
            const recordsList = document.getElementById('recordsList');
            
            // Show loading indicator
            recordsList.innerHTML = '<div class="no-records">Loading records...</div>';
            
            // Load records from cloud or localStorage
            const records = await loadFromCloud();
            
            if (records.length === 0) {
                recordsList.innerHTML = '<div class="no-records">No saved customer records yet.<br>Start saving calculations to build your customer database!</div>';
                return;
            }

            // Filter records based on search term
            const filteredRecords = records.filter(record => {
                const searchLower = searchTerm.toLowerCase();
                return record.customer.name.toLowerCase().includes(searchLower) ||
                       record.customer.phone.includes(searchLower) ||
                       record.vehicle.name.toLowerCase().includes(searchLower) ||
                       (record.customer.email && record.customer.email.toLowerCase().includes(searchLower));
            });

            if (filteredRecords.length === 0) {
                recordsList.innerHTML = '<div class="no-records">No records found matching your search.</div>';
                return;
            }

            let html = '';
            filteredRecords.forEach(record => {
                const date = new Date(record.timestamp);
                const formattedDate = date.toLocaleDateString('en-SG', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Determine pricing version badge
                const pricingVersion = record.pricingVersion || 'previous';
                const versionBadge = pricingVersion === 'current' 
                    ? '<span style="background: #4CAF50; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; margin-left: 8px;">Current Pricing</span>'
                    : '<span style="background: #FF9800; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; margin-left: 8px;">Previous Pricing</span>';

                html += `
                    <div class="record-card">
                        <div class="record-header">
                            <div class="record-name">${record.customer.name}${versionBadge}</div>
                            <div class="record-date">${formattedDate}</div>
                        </div>
                        <div class="record-details">
                            <div class="record-detail-item">
                                <span class="record-detail-label">Phone:</span> ${record.customer.phone || 'N/A'}
                            </div>
                            <div class="record-detail-item">
                                <span class="record-detail-label">Vehicle:</span> ${record.vehicle.name}
                            </div>
                            <div class="record-detail-item">
                                <span class="record-detail-label">Monthly:</span> ${record.loan.monthlyPayment}
                            </div>
                            <div class="record-detail-item">
                                <span class="record-detail-label">Email:</span> ${record.customer.email || 'N/A'}
                            </div>
                            <div class="record-detail-item">
                                <span class="record-detail-label">Down Payment:</span> $${record.loan.downPayment.toLocaleString('en-SG')}
                            </div>
                            <div class="record-detail-item">
                                <span class="record-detail-label">Loan Term:</span> ${record.loan.loanTerm} years
                            </div>
                        </div>
                        ${record.customer.notes ? `<div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-size: 0.9em;"><strong>Notes:</strong> ${record.customer.notes}</div>` : ''}
                        <div class="record-actions">
                            <button class="load-btn" onclick="loadRecord(${record.id})">Load Calculation</button>
                            <button class="delete-btn" onclick="deleteRecord(${record.id})">Delete</button>
                        </div>
                    </div>
                `;
            });

            recordsList.innerHTML = html;
        }

        function filterRecords() {
            const searchTerm = document.getElementById('searchRecords').value;
            displayRecords(searchTerm);
        }

        async function loadRecord(recordId) {
            // Load records from cloud or localStorage
            const records = await loadFromCloud();
            const record = records.find(r => r.id === recordId);
            
            if (!record) {
                alert('Record not found!');
                return;
            }

            // Close modal
            closeRecordsModal();

            // Auto-switch to the correct pricing version
            // For backwards compatibility: records without pricingVersion are from old pricelist
            const savedPricingVersion = record.pricingVersion || 'previous';
            const currentVersion = document.getElementById('pricingVersion').value;
            
            // If different pricing version, switch to the saved one
            if (savedPricingVersion !== currentVersion) {
                document.getElementById('pricingVersion').value = savedPricingVersion;
                switchPricingVersion();
                
                // Add a small delay to ensure pricing has switched
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Load customer information
            document.getElementById('customerName').value = record.customer.name;
            document.getElementById('customerPhone').value = record.customer.phone;
            document.getElementById('customerEmail').value = record.customer.email || '';
            document.getElementById('customerNotes').value = record.customer.notes || '';

            // Load vehicle and loan details
            document.getElementById('coeCategory').value = record.vehicle.coeCategory;
            filterVehiclesByCategory();
            
            setTimeout(() => {
                document.getElementById('vehicle').value = record.vehicle.model;
                loadVehicleData();
                
                setTimeout(() => {
                    // Set price mode
                    document.querySelector(`input[name="priceMode"][value="${record.loan.priceMode}"]`).checked = true;
                    togglePriceMode();
                    
                    if (record.loan.priceMode === 'package') {
                        document.getElementById('packageType').value = record.loan.packageType;
                        updateDownPayment();
                    } else {
                        document.getElementById('manualPrice').value = record.loan.sellingPrice;
                        updateManualDownPayment();
                    }
                    
                    // Set other loan details
                    document.getElementById('downPayment').value = record.loan.downPayment;
                    updateFromDollar();
                    document.getElementById('interestRate').value = record.loan.interestRate;
                    document.getElementById('loanTerm').value = record.loan.loanTerm;
                    
                    // Calculate
                    calculateLoan();
                    
                    // Show which pricing was loaded
                    const versionText = savedPricingVersion === 'current' ? 'Current (6 Nov - 19 Nov 2025)' : 'Previous (24 Oct - 5 Nov 2025)';
                    alert(`✓ Record loaded successfully!\n\nCustomer: ${record.customer.name}\nPricing Version: ${versionText}\n\nYou can now review or modify the calculation.`);
                }, 100);
            }, 100);
        }

        async function deleteRecord(recordId) {
            if (!confirm('Are you sure you want to delete this customer record? This action cannot be undone.')) {
                return;
            }

            // Delete from cloud or localStorage
            await deleteFromCloud(recordId);
            
            // Refresh the display
            displayRecords();
            
            const storageType = firebaseInitialized ? 'â˜ï¸ Cloud' : 'ðŸ’¾ Local';
            alert(`âœ… Record deleted from ${storageType} successfully!`);
        }

        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('recordsModal');
            if (event.target === modal) {
                closeRecordsModal();
            }
        });

        // Add keyboard shortcut to close modal (ESC key)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeRecordsModal();
                
                // Also close menu if open
                const menu = document.getElementById('menuDropdown');
                if (menu) {
                    menu.classList.remove('show');
                }
                
                // Also close customer form if open
                const customerCard = document.getElementById('customerInfoCard');
                if (customerCard && customerCard.classList.contains('show')) {
                    customerCard.classList.remove('show');
                }
            }
        });
    </script>
</body>
</html>
